{# templates/tisane/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Tisane : {{ tisane.nom }}{% endblock %}
{% block page_title %}{{ tisane.nom }}{% endblock %}

{% block content %}
    <div class="card shadow-lg border-0 rounded-4">
        <div class="row g-0">

            {# Colonne image - CORRIG√âE #}
            <div class="col-lg-5">
                {# Si l'image est d√©finie dans l'entit√©, on l'utilise #}
                {% if tisane.image %}
                    {% set imagePath = 'uploads/tisanes/' ~ tisane.image %}
                    <div class="ratio ratio-4x3">
                        <img
                                src="{{ asset(imagePath) }}"
                                alt="Photo de {{ tisane.nom }}"
                                class="img-fluid rounded shadow mb-3 tea-img"
                                onerror="this.onerror=null; this.src='{{ asset('images/placeholder-tea.jpg') }}';"
                        >
                    </div>
                {% else %}
                    {# Sinon, on utilise directement le placeholder #}
                    <div class="ratio ratio-4x3">
                        <img
                                src="{{ asset('images/placeholders/placeholder-tisane.jpg') }}"
                                alt="Photo de {{ tisane.nom }}"
                                class="img-fluid rounded shadow mb-3 tea-img"
                        >
                    </div>
                {% endif %}
            </div>

            {# Colonne contenu #}
            <div class="col-lg-7">
                <div class="card-body p-4">

                    {# Pr√©paration #}
                    <section class="mb-4" aria-labelledby="prep">
                        <h2 id="prep" class="h5 mb-2">Mode de pr√©paration</h2>
                        <p class="mb-0">{{ tisane.modePreparation|e|nl2br }}</p>
                    </section>

                    {# Dosage (si pr√©sent) #}
                    {% set dosage = attribute(tisane, 'dosage') ?? null %}
                    {% if dosage %}
                        <section class="mb-4" aria-labelledby="dose">
                            <h2 id="dose" class="h5 mb-2">Dosage / Posologie</h2>
                            <p class="mb-0">{{ dosage|e|nl2br }}</p>
                        </section>
                    {% endif %}

                    {# Bienfaits #}
                    <section class="mb-4" aria-labelledby="bienfaits">
                        <h2 id="bienfaits" class="h5 mb-2">Bienfaits</h2>
                        {% if tisane.bienfaits|length > 0 %}
                            <ul class="list-inline mb-0">
                                {% for b in tisane.bienfaits %}
                                    <li class="list-inline-item mb-1">
                                        <span class="badge bg-success-subtle text-success">{{ b.nom }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted mb-0">Aucun bienfait associ√©.</p>
                        {% endif %}
                    </section>

                    {# Plantes utilis√©es #}
                    <section class="card shadow-sm my-4" aria-labelledby="plantes-utilisees">
                        <div class="card-body">
                            <h2 id="plantes-utilisees" class="h5 card-title mb-3">üåø Plantes utilis√©es</h2>

                            {% set plantes = tisane.plantes|default([]) %}
                            {% if plantes is iterable and plantes|length > 0 %}
                                <ul class="mb-0">
                                    {% for p in plantes %}
                                        <li>
                                            <strong>{{ p.nomCommun }}</strong>
                                            {% if p.nomScientifique %}<em class="text-muted"> ({{ p.nomScientifique }})</em>{% endif %}
                                            {% if p.partieUtilisee %} ‚Äî {{ p.partieUtilisee }}{% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted mb-0">Aucune plante associ√©e.</p>
                            {% endif %}
                        </div>
                    </section>

                    {# PR√âCAUTIONS ‚Äî fallback depuis les plantes si vide #}
                    {% set precaut = attribute(tisane, 'precautions') ?? null %}
                    {% if not precaut %}
                        {% set _prec = [] %}
                        {% for p in tisane.plantes %}
                            {% if p.precautions %}
                                {% set _prec = _prec|merge([p.precautions]) %}
                            {% endif %}
                        {% endfor %}
                        {% set precaut = _prec|join('\n') %}
                    {% endif %}

                    {% if precaut %}
                        <section class="mb-4" aria-labelledby="precautions">
                            <h2 id="precautions" class="h5 mb-2">Pr√©cautions</h2>
                            {% set _lines = [] %}
                            {% for l in precaut|split('\n') %}
                                {% set l = l|trim %}
                                {% if l != '' %}
                                    {% set _lines = _lines|merge([l]) %}
                                {% endif %}
                            {% endfor %}
                            <div class="alert alert-warning mb-0">
                                {% if _lines|length > 1 %}
                                    <ul class="mb-0">
                                        {% for l in _lines %}<li class="mb-1">{{ l }}</li>{% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="mb-0">{{ precaut }}</p>
                                {% endif %}
                            </div>
                        </section>
                    {% endif %}

                    <p class="text-muted small mt-3">
                        ‚ö†Ô∏è Informations indicatives ‚Äî demandez l'avis d'un professionnel de sant√© en cas de doute.
                    </p>

                    <div class="d-flex justify-content-between flex-wrap gap-2 mt-3">
                        {% set back = {} %}
                        {% set back = back|merge({ page: app.request.query.get('page', 1) }) %}
                        {% if app.request.query.get('q') is not empty %}
                            {% set back = back|merge({ q: app.request.query.get('q') }) %}
                        {% endif %}

                        <a href="{{ path('tisane_index', back) }}" class="btn btn-outline-success">
                            Retour √† la liste
                        </a>
                    </div>

                </div>
            </div>

        </div>
    </div>
{% endblock %}