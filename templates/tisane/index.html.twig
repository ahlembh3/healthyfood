{# templates/tisane/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Liste des Tisanes{% endblock %}

{# --- Banni√®re compacte : titre align√© √† gauche + recherche dessus --- #}
{% block hero %}
    <section class="page-hero page-hero--sm"
             style="--hero-bg:url('{{ asset('images/banniere.png') }}')">
        <div class="page-hero__bg" aria-hidden="true"></div>
        <div class="page-hero__shade" aria-hidden="true"></div>

        {# padding r√©duit pour coller au header #}
        <div class="page-hero__inner container-content" style="padding-top:16px; padding-bottom:24px;">
            <h1 class="page-hero__title">üçµ <span class="text-vert">Tisanes</span></h1>
            <p class="text-muted mb-2">Recherchez une tisane par nom ou par bienfait.</p>

            <form method="get"
                  action="{{ path('tisane_index') }}"
                  class="hero-surface mt-2"
                  role="search"
                  aria-label="Rechercher une tisane">
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-8">
                        <label for="q" class="form-label">Rechercher une tisane</label>
                        <input type="text"
                               id="q"
                               name="q"
                               class="form-control"
                               placeholder="ex. Camomille, digestion‚Ä¶"
                               value="{{ query|default(app.request.query.get('q')) }}"
                               autocomplete="off">
                        {% if query is not empty %}
                            <small class="text-muted d-inline-block mt-1">
                                R√©sultats pour ¬´ {{ query }} ¬ª
                            </small>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-4 d-grid">
                        <button class="btn btn-primary" type="submit">Rechercher</button>
                    </div>
                </div>
            </form>
        </div>
    </section>
{% endblock %}

{# --- Liste + pagination --- #}
{% block content %}
    {% if tisanes is empty %}
        <section class="container-content py-4">
            <div class="alert alert-info mb-0">Aucune tisane trouv√©e.</div>
        </section>
    {% else %}
        <section class="container-content py-4" aria-labelledby="liste-tisanes">
            <h2 id="liste-tisanes" class="visually-hidden">Liste des tisanes</h2>

            <div class="row g-4">
                {% for tisane in tisanes %}
                    <div class="col-sm-6 col-md-4">
                        <article class="card h-100 shadow-sm border-0">
                            <div class="ratio ratio-4x3 bg-light">
                                {# --- Image : priorit√© BDD, sinon construction auto --- #}
                                {% set base  = tisane.nom|split('(')|first|trim %}
                                {% set ascii = base|lower|replace({
                                    '√©':'e','√®':'e','√™':'e','√´':'e','√†':'a','√¢':'a','√§':'a',
                                    '√Æ':'i','√Ø':'i','√¨':'i',
                                    '√¥':'o','√∂':'o','√≤':'o',
                                    '√π':'u','√ª':'u','√º':'u',
                                    '√ß':'c','≈ì':'oe','√¶':'ae',
                                    '‚Äô':'','\'':'','"':'','¬´':'','¬ª':''
                                }) %}
                                {% set slugLower = ascii|replace({
                                    '(':'',')':'','/':'_','\\':'_','&':'et',
                                    ',':'',':':'',';':'','?':'','!':'','.':'','-':'_','  ':' '
                                })|trim|replace({' ':'_'}) %}
                                {% set fileLower = 'uploads/tisanes/' ~ slugLower ~ '.png' %}
                                {% if slugLower starts with 'tisane_' %}
                                    {% set fileCap = 'uploads/tisanes/Tisane_' ~ slugLower|slice(7) ~ '.png' %}
                                {% else %}
                                    {% set fileCap = null %}
                                {% endif %}

                                {% set src = tisane.image
                                    ? asset('uploads/tisanes/' ~ tisane.image)
                                    :  asset('images/placeholders/placeholder-tisane.jpg')
                                %}

                                <img
                                        src="{{ src }}"
                                        alt="Tisane : {{ tisane.nom }}"
                                        class="w-100 h-100"
                                        style="object-fit:cover; object-position:center;"
                                        loading="lazy"
                                        onerror="
                                                this.onerror=null;
                                        {% if fileCap %}
                                                if(!this.dataset.alt){this.dataset.alt=1;this.src='{{ asset(fileCap) }}';}
                                                else{this.src='{{ asset('images/placeholder-tea.jpg') }}';}
                                        {% else %}
                                                this.src='{{ asset('images/placeholder-tea.jpg') }}';
                                        {% endif %}
                                                ">
                            </div>

                            <div class="card-body d-flex flex-column">
                                <h3 class="h5 card-title mb-2">{{ tisane.nom }}</h3>

                                {# Bienfaits (aper√ßu) #}
                                {% set bList = tisane.bienfaits|default([]) %}
                                {% if bList|length > 0 %}
                                    <div class="mb-2" aria-label="Bienfaits">
                                        {% for b in bList|slice(0,3) %}
                                            <span class="badge bg-success-subtle text-success me-1 mb-1">{{ b.nom }}</span>
                                        {% endfor %}
                                        {% if bList|length > 3 %}
                                            <span class="badge bg-secondary-subtle text-secondary">+{{ bList|length - 3 }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                {% set back = app.request.query.all|merge({ page: tisanes.currentPageNumber }) %}
                                <a href="{{ path('tisane_show', {'id': tisane.id}|merge(back)) }}"
                                   class="btn btn-outline-success mt-auto">Voir la fiche</a>
                            </div>
                        </article>
                    </div>
                {% endfor %}
            </div>

            <div class="pagination justify-content-center mt-4">
                {{ knp_pagination_render(tisanes, null, { query: app.request.query.all }) }}
            </div>
        </section>
    {% endif %}
{% endblock %}
