{# templates/tisane/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Liste des Tisanes{% endblock %}
{% block page_title %}üçµ Liste des tisanes{% endblock %}

{% block content %}
    {# --- Barre de recherche --- #}
    <section aria-labelledby="recherche-tisanes" class="mb-4">
        <h2 id="recherche-tisanes" class="visually-hidden">Recherche de tisanes</h2>

        <form method="get" action="{{ path('tisane_index') }}" role="search" aria-label="Rechercher une tisane">
            <div class="input-group">
                <label for="q" class="visually-hidden">Rechercher une tisane</label>
                <input
                        type="text"
                        id="q"
                        name="q"
                        class="form-control"
                        placeholder="Rechercher une tisane‚Ä¶"
                        value="{{ query|default(app.request.query.get('q')) }}"
                        autocomplete="off"
                >
                <button class="btn btn-primary" type="submit">Rechercher</button>
            </div>
            {% if query is not empty %}
                <small class="text-muted d-inline-block mt-2">
                    R√©sultats pour ¬´ {{ query }} ¬ª
                </small>
            {% endif %}
        </form>
    </section>

    {# --- Liste --- #}
    {% if tisanes is empty %}
        <div class="alert alert-info">Aucune tisane trouv√©e.</div>
    {% else %}
        <section aria-labelledby="liste-tisanes">
            <h2 id="liste-tisanes" class="visually-hidden">Tisanes</h2>

            <div class="row g-4">
                {% for tisane in tisanes %}
                    <div class="col-sm-6 col-md-4">
                        <article class="card h-100 shadow-sm border-0">
                            <div class="ratio ratio-4x3 bg-light">
                                {% set img = tisane.image|default('')|trim %}
                                {% set src = img ? asset('uploads/tisanes/' ~ img) : asset('images/placeholder-tea.jpg') %}
                                <img
                                        src="{{ src }}"
                                        alt="{{ img ? 'Photo de la tisane ' ~ tisane.nom : 'Image g√©n√©rique de tisane' }}"
                                        class="rounded-top w-100 h-100"
                                        style="object-fit: cover;"
                                        loading="lazy"
                                >
                            </div>

                            <div class="card-body">
                                <h3 class="h5 card-title mb-2">{{ tisane.nom }}</h3>

                                {% if tisane.modePreparation %}
                                    <p class="card-text text-muted mb-3">
                                        {{ tisane.modePreparation|striptags|u.truncate(140, '‚Ä¶') }}
                                    </p>
                                {% endif %}

                                {# Bienfaits (aper√ßu) #}
                                {% set bList = tisane.bienfaits|default([]) %}
                                {% if bList|length > 0 %}
                                    <div class="mb-2" aria-label="Bienfaits">
                                        {% for b in bList|slice(0,3) %}
                                            <span class="badge bg-success-subtle text-success me-1 mb-1">{{ b.nom }}</span>
                                        {% endfor %}
                                        {% if bList|length > 3 %}
                                            <span class="badge bg-secondary-subtle text-secondary">+{{ bList|length - 3 }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                {# Plantes (aper√ßu) #}
                                {% set pList = tisane.plantes|default([]) %}
                                {% if pList|length > 0 %}
                                    <p class="small text-muted mb-3">
                                        Plantes :
                                        {% for p in pList|slice(0,3) %}
                                            {{ loop.first ? '' : ', ' }}{{ p.nomCommun }}
                                        {% endfor %}
                                        {% if pList|length > 3 %} et {{ pList|length - 3 }} autre(s){% endif %}
                                    </p>
                                {% endif %}

                                <a
                                        href="{{ path('tisane_show', { id: tisane.id }) }}"
                                        class="btn btn-outline-primary"
                                        aria-label="Voir la fiche de {{ tisane.nom }}"
                                >
                                    Voir la fiche
                                </a>
                            </div>
                        </article>
                    </div>
                {% endfor %}
            </div>
        </section>
    {% endif %}
{% endblock %}
