{% extends 'base.html.twig' %}

{% block title %}Mes recettes{% endblock %}
{% block page_title %}Mes recettes{% endblock %}

{% block content %}
    {% if recettes is empty %}
        <div class="alert alert-info">Vous n'avez encore cr√©√© aucune recette.</div>
    {% else %}
        <div class="row g-4">
            {% for recette in recettes %}
                {% set title = recette.titre|default('') %}
                {% set ascii = title|lower|replace({
                    '√©':'e','√®':'e','√™':'e','√´':'e','√†':'a','√¢':'a','√§':'a','√π':'u','√ª':'u','√º':'u','√Æ':'i','√Ø':'i','√¥':'o','√∂':'o','√ß':'c',
                    '‚Äô':'','\'':'','"':'','(':'',')':'','/':'_','\\':'_','&':'et',',':'',':':'',';':'','?':'','!':'','.':'','-':'_'
                }) %}
                {% set slug  = ascii|replace({'  ':' '})|trim|replace({' ':'_'}) %}
                {% set guessJpg = 'uploads/recettes/' ~ slug ~ '.jpg' %}
                {% set guessPng = 'uploads/recettes/' ~ slug ~ '.png' %}

                {% set img  = recette.image|default('')|trim %}
                {% set src0 = img
                    ? (img starts with 'http' ? img : asset((img starts with 'uploads/' ? img : 'uploads/recettes/' ~ img)))
                    : asset(guessJpg)
                %}
                {% set src1 = asset(guessPng) %}
                {% set ph   = asset('images/placeholders/placeholder-recette.jpg') %}

                <div class="col-md-6 col-lg-4">
                    <article class="card h-100 shadow-sm">
                        <div class="ratio ratio-16x9 bg-light">
                            <img
                                    src="{{ src0 }}"
                                    alt="{{ title ?: 'Recette' }}"
                                    class="rounded-top w-100 h-100"
                                    style="object-fit: cover;"
                                    loading="lazy"
                                    onerror="if(!this.dataset.tryPng){this.dataset.tryPng=1;this.src='{{ src1 }}';}else{this.onerror=null;this.src='{{ ph }}';}"
                            >
                        </div>

                        <div class="card-body">
                            <h2 class="h5 card-title mb-2">{{ recette.titre }}</h2>
                            <p class="card-text text-muted">{{ recette.description|u.truncate(100, '‚Ä¶') }}</p>

                            <ul class="list-inline text-muted small mb-2">
                                {% if recette.difficulte %}
                                    <li class="list-inline-item"><span class="badge text-bg-secondary">{{ recette.difficulte }}</span></li>
                                {% endif %}
                                {% if recette.tempsPreparation %}
                                    <li class="list-inline-item">‚è± Pr√©paration : {{ recette.tempsPreparation }} min</li>
                                {% endif %}
                                {% if recette.tempsCuisson %}
                                    <li class="list-inline-item">üî• Cuisson : {{ recette.tempsCuisson }} min</li>
                                {% endif %}
                            </ul>
                        </div>

                        <div class="card-footer d-flex justify-content-between align-items-center gap-2">
                            <a
                                    class="btn btn-outline-primary flex-grow-1"
                                    href="{{ path('recette_show', { id: recette.id, from: 'mes' }) }}"
                                    aria-label="Voir la recette {{ recette.titre }}"
                            >Voir la recette</a>

                            {% if not recette.validation %}
                                <div class="btn-group">
                                    <a href="{{ path('recette_edit', { id: recette.id }) }}" class="btn btn-sm btn-secondary" aria-label="Modifier la recette {{ recette.titre }}">Modifier</a>
                                    <form
                                            method="post"
                                            action="{{ path('recette_delete', { id: recette.id }) }}"
                                            class="d-inline"
                                            onsubmit="if(confirm('Confirmer la suppression ?')){ this.querySelector('button[type=submit]').disabled = true; return true; } return false;"
                                    >
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ recette.id) }}">
                                        <button class="btn btn-sm btn-outline-danger" aria-label="Supprimer la recette {{ recette.titre }}">Supprimer</button>
                                    </form>
                                </div>
                            {% else %}
                                <span class="badge text-bg-success">Valid√©e</span>
                            {% endif %}
                        </div>
                    </article>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}
