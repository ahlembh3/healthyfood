{% form_theme form 'bootstrap_5_layout.html.twig' %}

<div class="card shadow p-4">
  <h2 class="h5 mb-4">{{ form_title|default('Recette') }}</h2>

  {{ form_start(form, {
    attr: { novalidate: 'novalidate', class: 'needs-validation', id: 'recette-form', 'aria-describedby': 'form-help' }
  }) }}

  <div id="form-help" class="visually-hidden">Renseignez le titre, les ingrédients, les étapes et les informations pratiques.</div>

  {% if form.vars.submitted and not form.vars.valid %}
    <div class="alert alert-danger mb-4" role="alert">Veuillez corriger les erreurs ci-dessous.</div>
  {% endif %}

  <div class="mb-3">
    {{ form_label(form.titre) }}
    {{ form_widget(form.titre, {'attr': {class: 'form-control', required: 'required', minlength: '3', maxlength: '255', autocomplete: 'off'}}) }}
    <div class="invalid-feedback d-block">{{ form_errors(form.titre) }}</div>
  </div>

  {# --- Image --- #}
  {% set current = form.vars.data ?? null %}
  {% set img = current and attribute(current,'image') ? attribute(current,'image') : '' %}
  {% set src = img ? asset((img starts with 'uploads/') ? img : 'uploads/recettes/' ~ img) : '' %}

  <div class="mb-3">
    {{ form_label(form.image) }}
    {{ form_widget(form.image, { attr: { class: 'form-control', onchange: 'previewImage(event)', accept: 'image/*' } }) }}
    <div class="invalid-feedback d-block">{{ form_errors(form.image) }}</div>

    <div class="mt-3">
      <p class="text-muted mb-2">Aperçu de l’image :</p>
      <img id="imagePreview"
           src="{{ src ? src : '#' }}"
           class="img-thumbnail {{ src ? '' : 'd-none' }}"
           data-original-src="{{ src }}"
           alt="Aperçu de l’image">
    </div>
  </div>

  {# --- Description --- #}
  <div class="mb-3">
    {{ form_label(form.description) }}
    {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 3}}) }}
    <div class="invalid-feedback d-block">{{ form_errors(form.description) }}</div>
  </div>

  {# --- Ingrédients (CollectionType) --- #}
  <div class="mb-3">
    <div class="d-flex align-items-center mb-2">
      <label class="form-label mb-0 me-2">Ingrédients</label>
      <button class="btn btn-sm btn-outline-primary ms-auto" data-add-ingredient>+ Ajouter un ingrédient</button>
    </div>

    {# message d’erreur de la collection #}
    {% set ri_errors = form_errors(form.recetteIngredients) %}
    {% if ri_errors is not empty %}
      <div class="alert alert-danger" role="alert">{{ ri_errors|raw }}</div>
    {% endif %}

    {% set proto = form_widget(form.recetteIngredients.vars.prototype) %}
    {% set count = form.recetteIngredients|length %}
    <div
            data-ingredients
            data-index="{{ count > 0 ? count : 1 }}"
            data-prototype="{{ proto|e('html_attr') }}"
    >
      {% if count > 0 %}
        {% for row in form.recetteIngredients %}
          <div class="ingredient-item border rounded p-3 mb-3 position-relative">
            {{ form_row(row) }}
            <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" data-remove-ingredient>&times;</button>
          </div>
        {% endfor %}
      {% else %}
        {# Fallback serveur : on rend 1 bloc basé sur le prototype (index 0) #}
        <div class="ingredient-item border rounded p-3 mb-3 position-relative">
          {{ proto|replace({'__name__': '0'})|raw }}
          <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2" data-remove-ingredient>&times;</button>
        </div>
      {% endif %}
    </div>
  </div>

  {# --- Instructions --- #}
  <div class="mb-3">
    {{ form_label(form.instructions) }}
    {{ form_widget(form.instructions, {'attr': {'class': 'form-control', 'rows': 6}}) }}
    <div class="invalid-feedback d-block">{{ form_errors(form.instructions) }}</div>
  </div>

  <div class="row">
    <div class="col-md-4 mb-3">
      {{ form_label(form.tempsPreparation) }}
      {{ form_widget(form.tempsPreparation, {'attr': {'class': 'form-control', 'min': 0}}) }}
      <div class="invalid-feedback d-block">{{ form_errors(form.tempsPreparation) }}</div>
    </div>
    <div class="col-md-4 mb-3">
      {{ form_label(form.tempsCuisson) }}
      {{ form_widget(form.tempsCuisson, {'attr': {'class': 'form-control', 'min': 0}}) }}
      <div class="invalid-feedback d-block">{{ form_errors(form.tempsCuisson) }}</div>
    </div>
    <div class="col-md-4 mb-3">
      {{ form_label(form.difficulte) }}
      {{ form_widget(form.difficulte, {'attr': {'class': 'form-select'}}) }}
      <div class="invalid-feedback d-block">{{ form_errors(form.difficulte) }}</div>
    </div>
  </div>

  <div class="mb-3">
    {{ form_label(form.portions) }}
    {{ form_widget(form.portions, {'attr': {'class': 'form-control', 'min': 1}}) }}
    <div class="invalid-feedback d-block">{{ form_errors(form.portions) }}</div>
  </div>

  <div class="d-flex justify-content-end mt-4">
    <button type="submit" class="btn btn-primary">{{ button_label|default('Soumettre') }}</button>
  </div>

  {{ form_end(form) }}
</div>
