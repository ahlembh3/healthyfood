{# templates/article/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ article.titre }} - Article{% endblock %}
{% block page_title %}{{ article.titre }}{% endblock %}

{% block content %}

    {# Flash messages #}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
        <div class="alert alert-warning">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('danger') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    {# En-t√™te article #}
    <div class="mb-3 text-muted">
        <span class="me-3"><strong>Cat√©gorie :</strong> {{ article.categorie ?? '‚Äî' }}</span>
        <span class="me-3"><strong>Publi√© le :</strong> {{ article.date ? article.date|date('d/m/Y') : '‚Äî' }}</span>
        <span><strong>Statut :</strong>
      {% if article.validation %}
          <span class="badge bg-success">Valid√©</span>
      {% else %}
          <span class="badge bg-warning text-dark">En attente</span>
      {% endif %}
    </span>
    </div>

    {# Image #}
    {% set imgSrc = article.image ? asset('uploads/' ~ article.image) : asset('images/placeholders/placeholder-article.jpg') %}
    <figure class="my-3">
        <img
                src="{{ imgSrc }}"
                alt="Illustration : {{ article.titre }}"
                class="img-fluid rounded shadow"
                style="max-height: 420px; object-fit: cover; width: 100%;"
                loading="lazy"
                onerror="this.onerror=null;this.src='{{ asset('images/placeholders/placeholder-article.jpg') }}'">
    </figure>

    {# Contenu (SANS |raw : on nettoie tout HTML potentiel) #}
    {% set raw = article.contenu|default('') %}
    {% set normalized = raw
        |replace({'<br>':'\n','<br/>':'\n','<br />':'\n'})
        |striptags
        |trim
    %}
    {# Contenu assaini c√¥t√© contr√¥leur, pas de |raw n√©cessaire #}
    <section class="border p-3 rounded bg-light">
        {% if contenu %}
            {{ contenu }}
        {% else %}
            <p class="text-muted m-0">Aucun contenu.</p>
        {% endif %}
    </section>


    <p class="mt-3"><strong>Auteur :</strong> {{ article.utilisateur ? article.utilisateur.email : 'Compte supprim√©' }}</p>

    {# Validation admin #}
    {% if is_granted('ROLE_ADMIN') %}
        {% if not article.validation %}
            <form method="post"
                  action="{{ path('article_valider', {id: article.id}) }}"
                  onsubmit="if(confirm('Confirmer la validation de cet article ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                <input type="hidden" name="_token" value="{{ csrf_token('valider' ~ article.id) }}">
                <button class="btn btn-success">Valider l‚Äôarticle</button>
            </form>
        {% else %}
            <div class="alert alert-success mt-3">Cet article est d√©j√† valid√©.</div>
        {% endif %}
    {% endif %}

    <hr class="my-5">

    {# Commentaires #}
    <h2 class="h4 mb-3">Commentaires</h2>

    {% if commentaires|length > 0 %}
        <div class="list-group mb-4">
            {% for commentaire in commentaires %}
                <article class="list-group-item">
                    <header class="d-flex justify-content-between align-items-start">
                        <strong>{{ commentaire.utilisateur ? (commentaire.utilisateur.prenom ?: commentaire.utilisateur.email) : 'Compte supprim√©' }}</strong>
                        <small class="text-muted">{{ commentaire.date ? commentaire.date|date('d/m/Y H:i') : '' }}</small>
                    </header>
                    <p class="mt-2 mb-0">{{ commentaire.contenu }}</p>

                    {% if is_granted('IS_AUTHENTICATED_FULLY') and commentaire.utilisateur and commentaire.utilisateur.id != app.user.id %}
                        {% if commentaire.signaler and commentaire.signalePar and commentaire.signalePar.id == app.user.id %}
                            <p class="text-warning small mt-2 mb-0">D√©j√† signal√©</p>
                        {% else %}
                            <form method="post"
                                  action="{{ path('commentaire_signaler', { id: commentaire.id }) }}"
                                  class="mt-2"
                                  onsubmit="if(confirm('Voulez-vous signaler ce commentaire ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                                <input type="hidden" name="_token" value="{{ csrf_token('signaler' ~ commentaire.id) }}">
                                <button class="btn btn-sm btn-outline-danger">
                                    üö© Signaler
                                </button>
                            </form>
                        {% endif %}
                    {% endif %}
                </article>
            {% endfor %}
        </div>

        <div class="pagination justify-content-center">
            {{ knp_pagination_render(commentaires) }}
        </div>
    {% else %}
        <p class="text-muted">Aucun commentaire pour le moment.</p>
    {% endif %}

    {# Formulaire d‚Äôajout de commentaire : tout utilisateur connect√© #}
    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        <h3 class="h5 mt-4">Ajouter un commentaire</h3>
        {{ form_start(formCommentaire, { attr: { id: 'form_commentaire' } }) }}
        <div class="mb-3">
            {{ form_label(formCommentaire.contenu, 'Votre commentaire') }}
            {{ form_widget(formCommentaire.contenu, { attr: { class: 'form-control', rows: 3 } }) }}
            {{ form_errors(formCommentaire.contenu) }}
        </div>
        <button type="submit" class="btn btn-primary">Envoyer</button>
        {{ form_end(formCommentaire) }}
    {% else %}
        <p class="text-muted">Connectez-vous pour ajouter un commentaire.</p>
    {% endif %}

    {# Boutons bas de page (Retour / Modifier / Supprimer) #}
    {% set from = app.request.get('from')|default('') %}
    {% set backRoute = 'article_index' %}
    {% set backParams = {} %}

    {% if from == 'liste' %}
        {% set backRoute = 'article_index' %}
        {% set backParams = {
            q: app.request.get('q'),
            categorie: app.request.get('categorie'),
            page: app.request.get('page')|default(1)
        } %}
    {% elseif from == 'admin' %}
        {% set backRoute = 'article_liste_admin' %}
    {% elseif from == 'mes' %}
        {% set backRoute = 'article_mes_articles' %}
    {% endif %}

    <div class="d-flex gap-2 mt-4 flex-wrap">
        <a href="{{ path(backRoute, backParams) }}" class="btn btn-secondary">‚Üê Retour</a>

        {% if canEdit %}
            <a href="{{ path('article_edit', { id: article.id, from: from }) }}" class="btn btn-primary btn-sm">Modifier</a>
            {{ include('article/_delete_form.html.twig') }}
        {% endif %}
    </div>

{% endblock %}
