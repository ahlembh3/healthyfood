{# templates/article/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ article.titre }} - Article{% endblock %}
{% block page_title %}{{ article.titre }}{% endblock %}

{% block content %}
    {# Qui peut voir/√©diter ? #}
    {% set isOwner = app.user and article.utilisateur and app.user.id == article.utilisateur.id %}
    {% set canEdit = is_granted('ROLE_ADMIN') or isOwner %}


    {# Flash messages #}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
        <div class="alert alert-warning">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('danger') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    {# En-t√™te article #}
    <div class="mb-3 text-muted">
        <span class="me-3"><strong>Cat√©gorie :</strong> {{ article.categorie ?? '‚Äî' }}</span>
        <span class="me-3"><strong>Publi√© le :</strong> {{ article.date ? article.date|date('d/m/Y') : '‚Äî' }}</span>

        {% if canEdit %}
            <span>
      <strong>Statut :</strong>
      {% if article.validation %}
          <span class="badge bg-success">Valid√©</span>
      {% else %}
          <span class="badge bg-warning text-dark">En attente</span>
      {% endif %}
    </span>
        {% endif %}
    </div>


    {# Image #}
    {% set imgSrc = article.image ? asset('uploads/' ~ article.image) : asset('images/placeholders/placeholder-article.jpg') %}
    <figure class="my-3">
        <img
                src="{{ imgSrc }}"
                alt="Illustration : {{ article.titre }}"
                class="img-fluid rounded shadow"
                style="max-height: 420px; object-fit: cover; width: 100%;"
                loading="lazy"
                onerror="this.onerror=null;this.src='{{ asset('images/placeholders/placeholder-article.jpg') }}'">
    </figure>

    {# --- Contenu : Titre + texte (mise en page minimale si pas de HTML) --- #}
    {% set raw = article.contenu|default('') %}
    {% set text = raw|replace({'<br>':'\n','<br/>':'\n','<br />':'\n'})|trim %}
    <section class="card shadow-sm p-3">
        <h2 class="h5 mb-3">üìù Titre</h2>
        <p class="fw-semibold mb-3">{{ article.titre }}</p>

        <h2 class="h5 mb-2">üìÑ Contenu</h2>
        {# s‚Äôil y a des balises courantes, on suppose du HTML d√©j√† mis en forme #}
        {% if '<p' in raw or '<ul' in raw or '<ol' in raw or '<div' in raw or '<h' in raw or '<br' in raw %}
            {{ raw|raw }}
        {% else %}
            <div class="lh-base" style="white-space:pre-line">
                {{ text|striptags }}
            </div>
        {% endif %}
    </section>

    {# --- Auteur --- #}
    <p class="mt-3">
        <strong>Auteur :</strong>
        {{ article.utilisateur ? (article.utilisateur.prenom ~ ' ' ~ article.utilisateur.nom)|trim : 'Compte supprim√©' }}
    </p>

    {# --- Source : lien si c‚Äôest une URL, sinon texte brut --- #}
    {% set src = article.source|default('')|trim %}
    {% if src %}
        {% set isUrl = src starts with 'http://' or src starts with 'https://' or src starts with '//' or src starts with 'www.' %}
        <p class="mt-2">
            <strong>Source :</strong>
            {% if isUrl %}
                {% set href = src starts with 'www.' ? 'https://' ~ src : (src starts with '//' ? 'https:' ~ src : src) %}
                <a href="{{ href|e('html_attr') }}" target="_blank" rel="noopener nofollow">{{ src }}</a>
            {% else %}
                {{ src }}
            {% endif %}
        </p>
    {% endif %}


    {# Validation admin #}
    {% if is_granted('ROLE_ADMIN') %}
        {% if not article.validation %}
            <form method="post"
                  action="{{ path('article_valider', {id: article.id}) }}"
                  onsubmit="if(confirm('Confirmer la validation de cet article ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                <input type="hidden" name="_token" value="{{ csrf_token('valider' ~ article.id) }}">
                <button class="btn btn-success">Valider l‚Äôarticle</button>
            </form>
        {% else %}
            <div class="alert alert-success mt-3">Cet article est d√©j√† valid√©.</div>
        {% endif %}
    {% endif %}

    <hr class="my-5">

    {# Commentaires #}
    <h2 class="h4 mb-3">Commentaires</h2>

    {% if commentaires|length > 0 %}
        <div class="list-group mb-4">
            {% for commentaire in commentaires %}
                <article class="list-group-item">
                    <header class="d-flex justify-content-between align-items-start">
                        <strong>{{ commentaire.utilisateur ? (commentaire.utilisateur.prenom ?: commentaire.utilisateur.email) : 'Compte supprim√©' }}</strong>
                        <small class="text-muted">{{ commentaire.date ? commentaire.date|date('d/m/Y H:i') : '' }}</small>
                    </header>
                    <p class="mt-2 mb-0">{{ commentaire.contenu }}</p>

                    {% if is_granted('IS_AUTHENTICATED_FULLY') and commentaire.utilisateur and commentaire.utilisateur.id != app.user.id %}
                        {% if commentaire.signaler and commentaire.signalePar and commentaire.signalePar.id == app.user.id %}
                            <p class="text-warning small mt-2 mb-0">D√©j√† signal√©</p>
                        {% else %}
                            <form method="post"
                                  action="{{ path('commentaire_signaler', { id: commentaire.id }) }}"
                                  class="mt-2"
                                  onsubmit="if(confirm('Voulez-vous signaler ce commentaire ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                                <input type="hidden" name="_token" value="{{ csrf_token('signaler' ~ commentaire.id) }}">
                                <button class="btn btn-sm btn-outline-danger">
                                    üö© Signaler
                                </button>
                            </form>
                        {% endif %}
                    {% endif %}
                </article>
            {% endfor %}
        </div>

        <div class="pagination justify-content-center">
            {{ knp_pagination_render(commentaires) }}
        </div>
    {% else %}
        <p class="text-muted">Aucun commentaire pour le moment.</p>
    {% endif %}

    {# Formulaire d‚Äôajout de commentaire : tout utilisateur connect√© #}
    {% if is_granted('IS_AUTHENTICATED_FULLY') %}
        <h3 class="h5 mt-4">Ajouter un commentaire</h3>
        {{ form_start(formCommentaire, { attr: { id: 'form_commentaire' } }) }}
        <div class="mb-3">
            {{ form_label(formCommentaire.contenu, 'Votre commentaire') }}
            {{ form_widget(formCommentaire.contenu, { attr: { class: 'form-control', rows: 3 } }) }}
            {{ form_errors(formCommentaire.contenu) }}
        </div>
        <button type="submit" class="btn btn-primary">Envoyer</button>
        {{ form_end(formCommentaire) }}
    {% else %}
        <p class="text-muted">Connectez-vous pour ajouter un commentaire.</p>
    {% endif %}

    {# --- Boutons bas de page (Retour / Modifier / Supprimer) --- #}

    {# 1) On privil√©gie l'URL calcul√©e par le contr√¥leur (`backUrl`) #}
    {# 2) Sinon, on utilise le Referer s'il est interne #}
    {# 3) Sinon, on retombe sur la liste publique #}

    {% set candidate = backUrl ?? app.request.headers.get('referer') ?? '' %}
    {% set host = app.request.schemeAndHttpHost %}
    {% set urlRetour = (candidate starts with host) or (candidate starts with '/')
        ? candidate
        : path('article_liste')
    %}

    <div class="d-flex gap-2 mt-4 flex-wrap">
        <a href="{{ urlRetour }}"
           class="btn btn-secondary"
           onclick="
       try {
         if (document.referrer) {
           const u = new URL(document.referrer);
           if (u.host === location.host) { history.back(); return false; }
         }
       } catch (_) {}
       /* sinon, on laisse le href faire son job */
     ">
            ‚Üê Retour √† la liste
        </a>

        {% set isOwner = app.user and article.utilisateur and app.user.id == article.utilisateur.id %}
        {% set canEdit = is_granted('ROLE_ADMIN') or isOwner %}
        {% if canEdit %}
            <a href="{{ path('article_edit', { id: article.id }) }}" class="btn btn-primary btn-sm">Modifier</a>
            {{ include('article/_delete_form.html.twig') }}
        {% endif %}
    </div>




{% endblock %}
