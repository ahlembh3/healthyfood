{# templates/commentaire/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Détail du commentaire{% endblock %}
{% block page_title %}Détail du commentaire{% endblock %}

{% block content %}
    <article class="card shadow-sm mb-3 {{ commentaire.signaler ? 'border border-danger' : '' }}">
        <div class="card-body">
            <header class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <h2 class="h5 card-title mb-1">
                        {{ commentaire.utilisateur ? commentaire.utilisateur.email : 'Compte supprimé' }}
                    </h2>
                    <p class="card-subtitle text-muted small mb-0">
                        {{ commentaire.date ? commentaire.date|date('d/m/Y H:i') : '' }}
                    </p>
                </div>
                <span class="badge bg-{{ commentaire.signaler ? 'danger' : 'success' }}">
          {{ commentaire.signaler ? 'Signalé' : 'Valide' }}
        </span>
            </header>

            <hr class="my-3">

            <p class="card-text mb-2">{{ commentaire.contenu }}</p>
            <p class="mb-2"><strong>Note :</strong> {{ commentaire.note is not null ? commentaire.note : 'Non notée' }}</p>

            {# Lien vers le contenu associé #}
            {% if commentaire.recette %}
                <p class="mb-2">
                    <strong>Recette :</strong>
                    <a href="{{ path('recette_show', { id: commentaire.recette.id }) }}">
                        {{ commentaire.recette.titre }}
                    </a>
                </p>
            {% elseif commentaire.article %}
                <p class="mb-2">
                    <strong>Article :</strong>
                    <a href="{{ path('article_show', { id: commentaire.article.id }) }}">
                        {{ commentaire.article.titre }}
                    </a>
                </p>
            {% else %}
                <p class="mb-2"><strong>Contenu :</strong> Non lié</p>
            {% endif %}
        </div>
    </article>

    <div class="d-flex gap-2 flex-wrap mt-3 align-items-center">
        {# Suppression : réservé aux rôles autorisés (vérifie côté contrôleur aussi) #}
        <form method="post"
              action="{{ path('commentaire_delete', { id: commentaire.id }) }}"
              class="d-inline"
              onsubmit="if(confirm('Voulez-vous vraiment supprimer ce commentaire ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commentaire.id) }}">
            <button class="btn btn-danger">Supprimer</button>
        </form>

        {# Désignaler : admin uniquement quand il est signalé #}
        {% if commentaire.signaler and is_granted('ROLE_ADMIN') %}
            <form method="post"
                  action="{{ path('commentaire_designaler', { id: commentaire.id }) }}"
                  class="d-inline"
                  onsubmit="if(confirm('Voulez-vous désignaliser ce commentaire ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                <input type="hidden" name="_token" value="{{ csrf_token('designaler' ~ commentaire.id) }}">
                <button class="btn btn-success">Désignaler</button>
            </form>
        {% endif %}

        {# Signaler : utilisateur connecté, non-admin, non-auteur, et pas déjà signalé #}
        {% if is_granted('IS_AUTHENTICATED_FULLY')
            and not is_granted('ROLE_ADMIN')
            and not commentaire.signaler
            and commentaire.utilisateur and app.user and commentaire.utilisateur.id != app.user.id %}
            <form method="post"
                  action="{{ path('commentaire_signaler', { id: commentaire.id }) }}"
                  class="d-inline"
                  onsubmit="if(confirm('Voulez-vous signaler ce commentaire ?')){ this.querySelector('button[type=submit]').disabled = true; return true;} return false;">
                <input type="hidden" name="_token" value="{{ csrf_token('signaler' ~ commentaire.id) }}">
                <button class="btn btn-warning">Signaler</button>
            </form>
        {% endif %}

        <a href="{{ path('commentaire_index') }}" class="btn btn-outline-secondary">Retour à la liste</a>
    </div>
{% endblock %}
